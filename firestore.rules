rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Users collection - users can read/write their own data, admins can read all
    match /users/{userId} {
      allow read: if isAuthenticated();
      // Allow users to create their own profile during registration
      allow create: if isAuthenticated() && request.auth.uid == userId;
      // Allow users to update their own profile or admins to update any profile
      allow update: if isOwner(userId) || isAdmin();
      // Only admins can delete users
      allow delete: if isAdmin();
    }
    
    // Usuarios collection (same as users)
    match /usuarios/{userId} {
      allow read: if isAuthenticated();
      // Allow users to create their own profile during registration
      allow create: if isAuthenticated() && request.auth.uid == userId;
      // Allow users to update their own profile or admins to update any profile
      allow update: if isOwner(userId) || isAdmin();
      // Only admins can delete users
      allow delete: if isAdmin();
    }
    
    // Groups - authenticated users can read, admins can write
    match /groups/{groupId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Grupos (same as groups)
    match /grupos/{groupId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Reports - authenticated users can read, admins can write
    match /reportes/{reportId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Resources - authenticated users can read, admins can write
    match /resources/{resourceId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Recursos (same as resources)
    match /recursos/{resourceId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Test data - only for development
    match /pruebas/{testId} {
      allow read, write: if isAuthenticated();
    }
    
    // Test collections for connection testing
    match /test_connection/{docId} {
      allow read, write: if true;
    }
    
    match /test_write/{docId} {
      allow read, write: if true;
    }
    
    // Modules - authenticated users can read, admins can write
    match /modulos/{moduloId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Messages - authenticated users can read, admins can write
    match /mensajes/{mensajeId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // User progress - users can read/write their own progress
    match /userProgress/{progressId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Discipleship entries - users can read/write their own entries
    match /discipleship/{entryId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Sermons - authenticated users can read, admins can write
    match /sermons/{sermonId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Sermon series - authenticated users can read, admins can write
    match /sermonSeries/{seriesId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Analytics - authenticated users can write, admins can read
    match /analytics/{analyticsId} {
      allow read: if isAdmin();
      allow write: if isAuthenticated();
    }
    
    // Stats - authenticated users can read, system can write
    match /stats/{statId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Members - authenticated users can read, admins can write
    match /members/{memberId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Attendance - authenticated users can read, admins can write
    match /attendance/{attendanceId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Announcements - authenticated users can read, admins can write
    match /announcements/{announcementId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Zones - authenticated users can read, admins can write
    match /zones/{zoneId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Group member roles - authenticated users can read, admins can write
    match /groupMemberRoles/{roleId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Custom permissions - admins only
    match /customPermissions/{permissionId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
  }
}
